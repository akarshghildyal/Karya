-- Users table
CREATE TABLE IF NOT EXISTS users (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  role TEXT CHECK (role IN ('Admin', 'Vendor', 'Driver')) DEFAULT 'Vendor',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  parent_vendor_id BIGINT
);

-- Vendors table
DROP TABLE IF EXISTS vendors CASCADE;
CREATE TABLE vendors (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT UNIQUE NOT NULL,
  created_by BIGINT REFERENCES users (id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  parent_vendor_id BIGINT REFERENCES vendors (id) ON DELETE SET NULL
);


-- Drivers table
CREATE TABLE IF NOT EXISTS drivers (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  name TEXT NOT NULL,
  phone TEXT UNIQUE NOT NULL,
  license_number TEXT UNIQUE NOT NULL,
  vendor_id BIGINT REFERENCES vendors (id) ON DELETE CASCADE,
  assigned_vehicle_id BIGINT UNIQUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Vehicles table
CREATE TABLE IF NOT EXISTS vehicles (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  registration_number TEXT UNIQUE NOT NULL,
  model TEXT NOT NULL,
  seating_capacity INT CHECK (seating_capacity > 0),
  vendor_id BIGINT REFERENCES vendors (id) ON DELETE CASCADE,
  assigned_driver_id BIGINT UNIQUE REFERENCES drivers (id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Roles table
CREATE TABLE IF NOT EXISTS roles (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  role_name TEXT UNIQUE NOT NULL CHECK (role_name IN ('Admin', 'Vendor', 'Driver')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- User Roles table
CREATE TABLE IF NOT EXISTS user_roles (
  user_id BIGINT REFERENCES users (id) ON DELETE CASCADE,
  role_id BIGINT REFERENCES roles (id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id)
);

-- Driver Documents table
CREATE TABLE IF NOT EXISTS driver_documents (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  driver_id BIGINT UNIQUE REFERENCES drivers (id) ON DELETE CASCADE,
  license_number TEXT UNIQUE NOT NULL,
  license_expiry DATE NOT NULL,
  document_url TEXT NOT NULL,
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
